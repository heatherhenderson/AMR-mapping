---
title: "Antimicrobial-resistant Enterobacterales in people with HIV: 2019-2021"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, error = FALSE, eval = TRUE, tidy = TRUE, cache = FALSE)
```

```{r libraries}
packages <- function(x){
  for(i in x){
     if(!require(i, character.only = TRUE)){
      install.packages(i, dependencies = TRUE)
       library(i, character.only = TRUE)
    }
  }
}
packages(c("readr", "readxl", "haven", "tidyverse" , "data.table" , "naniar", "rockchalk", "lubridate", "kableExtra", "DT", "formatR", "zoo", "binom", "plotly", "janitor", "sjlabelled", "Hmisc", "rms", "aod", "sandwich", "lmtest", "tableone", "broom", "gmodels", "arsenal", "investr", "lessR", "RColorBrewer"))
```

# **Raw data files**

```{r raw data files}
options(scipen=999)
setwd("C:/Users/henderh/Desktop/Projects/HAMR/HAMR_new_Rproj")
# Read in raw data
susceptibility_results <- read_delim("Z:/Susceptibilities_HIVStatus_June_2019_June29_2021/Cultures_and_Susceptibilities_June_2019_June_29_2021.csv", delim = "|", escape_double = FALSE, trim_ws = TRUE)
hiv_diagnoses <- read_excel("Z:/Susceptibilities_HIVStatus_June_2019_June29_2021/HIV_DX_April_4_2014_to_June_29_2021.xlsx")
hiv_lab_results <- read_excel("Z:/Susceptibilities_HIVStatus_June_2019_June29_2021/HIV_Lab_Results_April_4_2014_June29_2021.xlsx")
antibiotics <- read.csv("Z:/CDWH_request_48469_70000_patients/antibiotics.csv", stringsAsFactors = FALSE)
int_res <- read.csv("Z:/CDWH_request_48469_70000_patients/intrinsic_resistance.csv", stringsAsFactors = FALSE)
breakpoints <- read.csv("Z:/CDWH_request_48469_70000_patients/breakpoints.csv", stringsAsFactors = FALSE)
abx_classes <- breakpoints %>% clean_names() %>% mutate_all(list(tolower)) %>% select(antibiotic, class)
cohort <- read_sas("J:/ID/Antibacterial resistance in PLWH/CFAR Data/_FROM MATT_/amr_clean.sas7bdat", NULL)
cohort_new <- read_sas("uchcc_mrns.sas7bdat", NULL)
data10 <- readRDS("Z:/final_dataset.rds")
demographics <- read_excel("Z:/Brown_Dylan/VAN_DUIN_IRB18-3438_PATIENT_DEMOGRAPHICS.xlsx")
patient_summary <- read_excel("Z:/Susceptibilities_HIVStatus_June_2019_June29_2021/Patients_Summary_Susceptibilties_HIV.xlsx")
organisms <- read.csv("Z:culture_results.csv", stringsAsFactors = FALSE)
```

# **Data Cleaning**

### **HIV diagnoses**

```{r}
uchcc <- cohort %>%
  clean_names() %>%
  mutate_all(list(tolower)) %>%
  select(pat_mrn_id, dxdate) %>%
  filter(pat_mrn_id != "") %>%
  mutate(dxdate = ifelse(dxdate == "1777-06-15", "NA", dxdate),
         dxdate = as.Date(dxdate))
hiv_dx <- hiv_diagnoses %>%
  clean_names() %>%
  mutate_all(list(tolower)) %>%
  mutate(dxcode_date = as.Date(encounter_or_noted_date)) %>%
  add_count(pat_mrn_id) %>%
  group_by(pat_mrn_id) %>%
  slice_min(dxcode_date) %>%
  ungroup() %>%
  select(-encounter_or_noted_date)
hiv_labs <- hiv_lab_results %>%
  clean_names() %>%
  mutate_all(list(tolower)) %>%
  mutate(lab_date = as.Date(specimen_taken_time)) %>%
  filter(!str_detect(ord_value, pattern = "non|not|neg|indeterm|cancel|<|comment|scanned|tnp|uptcal"),
         ord_value != ".") %>%
  group_by(pat_mrn_id) %>%
  slice_min(lab_date) %>%
  ungroup() %>%
  select(pat_mrn_id, lab_date, ordered_test_description, ord_value, abnormal_code, component_comment)
susc <- susceptibility_results %>%
  clean_names() %>%
  mutate_all(list(tolower)) %>%
  mutate(birth_date = as.Date(birth_date),
         result_date = as.Date(result_date),
         culture_year = as.numeric(year(result_date)),
         age = floor(as.numeric(result_date - birth_date) / 365.25))
hivpos <- susc %>%
  select(pat_mrn_id, result_date) %>%
  left_join(uchcc %>% 
              select(pat_mrn_id, dxdate)) %>%
  left_join(hiv_dx %>% 
              select(pat_mrn_id, dxcode_date, n)) %>%
  left_join(hiv_labs %>% 
              select(pat_mrn_id, lab_date)) %>%
  left_join(cohort_new %>%
              mutate(uchcc = TRUE)) %>%
  mutate(dxdate = as.Date(dxdate)) %>%
  mutate(dx_date_new = pmin(dxdate, dxcode_date, lab_date, na.rm = TRUE)) %>%
  filter(!is.na(dx_date_new),
         (result_date - dx_date_new) > -35) %>%
  unique() %>%
  select(pat_mrn_id, result_date) %>%
  mutate(pwh = TRUE)
# 273 PWH, 261 with culture after dx date
```

### **Culture and susceptibility results**

```{r}
pts <- patient_summary %>%
  clean_names() %>%
  mutate_all(list(tolower)) %>%
  select(pat_mrn_id, gender, race1, race2, ethnicity) %>%
  mutate(race = ifelse(race1 %in% c("other race", "other/hispanic", "prefer not to answer", "unknown"), race2, race1),
         race = case_when(race1 == "white or caucasian" ~ "white",
                               race1 == "black or african american" ~ "black",
                               TRUE ~ "other"),
         ethnicity = case_when(ethnicity == "hispanic or latino" ~ "hispanic",
                               ethnicity == "not hispanic or latino" ~ "nonhispanic",
                               TRUE ~ "unknown"),
         female = ifelse(gender == "female", TRUE, FALSE))
susc <- susceptibility_results %>%
  clean_names() %>%
  mutate_all(list(tolower)) %>%
  mutate(birth_date = as.Date(birth_date),
         result_date = as.Date(result_date),
         culture_year = as.numeric(year(result_date)),
         age = floor(as.numeric(result_date - birth_date) / 365.25))
susc1 <- susc %>%
  select(pat_mrn_id, encounter_number, age, department_name, parent_hospital, specimen_type, organism_name, result_date, antibiotic, susceptibility, culture_year, zip) %>%
  filter(susceptibility %in% c("intermediate", "resistant", "susceptible"),
         !antibiotic %in% c("esbl", "rmesbl")) %>%
  rename(antibiotic_old = antibiotic,
         organism_name_old = organism_name) %>%
  left_join(antibiotics) %>%
  left_join(organisms) %>%
  mutate(nonsusceptible = ifelse(susceptibility == "susceptible", FALSE, TRUE)) %>%
  left_join(abx_classes) %>%
  left_join(int_res %>% mutate(int_res = TRUE)) %>%
  filter(genus != "",
         is.na(int_res),
         antibiotic != "cefazolin",
         specimen_type != "outreach-not indicated") %>%
  select(-c(department_name, parent_hospital, organism_name_old, antibiotic_old, int_res, zip))
names(susc1)
```

#### **Recode specimen source**

```{r}
resp <- susc1 %>%
  select(specimen_type) %>%
  filter((str_detect(specimen_type, pattern = "bronch|phar|sput|trach"))) %>%
  unique()
urine <- susc1 %>%
  select(specimen_type) %>%
  filter((str_detect(specimen_type, pattern = "urine"))) %>%
  unique()
other_src <- susc1 %>%
  select(specimen_type) %>%
  filter(!specimen_type %in% resp$specimen_type,
         !specimen_type %in% urine$specimen_type) %>%
  unique()
susc2 <- susc1 %>%
  mutate(source = case_when(specimen_type == "blood" ~ specimen_type,
                            specimen_type %in% resp$specimen_type ~ "resp",
                            specimen_type %in% urine$specimen_type ~ "urine",
                            specimen_type %in% other_src$specimen_type ~ "other"),
         source = factor(source, levels = c("urine", "blood", "resp", "other")),
         genus = str_replace(genus, pattern = " .*", replacement = "")) %>%
  unique() %>%
  filter(!is.na(class),
         !class %in% c("amphenicol", "cephalosporin_1st_gen", "glycopeptide", "lipopeptide", "macrolide", "oxazolidinone")) %>%
  group_by(encounter_number, organism_name, class) %>%
  mutate(resistant_to_class = ifelse(sum(nonsusceptible) > 0, TRUE, FALSE)) %>%
  ungroup()
rm(resp,urine,other_src)
```

#### **Select isolates from blood -> respiratory -> urine -> other**

```{r}
isolates_to_keep <- susc2 %>%
  group_by(encounter_number, result_date, organism_name, source) %>%
  summarise() %>%
  ungroup() %>%
  add_count(encounter_number, result_date, organism_name) %>%
  filter(n == 1 | n > 1 & source == "blood" | n > 1 & source == "resp") %>%
  select(-n) %>%
  add_count(encounter_number, result_date, organism_name) %>%
  filter(n == 1 | n > 1 & source == "blood") %>%
  select(-n)
susc3 <- susc2 %>%
  inner_join(isolates_to_keep) %>%
  select(pat_mrn_id, encounter_number, organism_name, result_date) %>%
  distinct() %>%
  group_by(pat_mrn_id, organism_name) %>%
  slice_min(result_date) %>%
  ungroup()
# 50,098 patients
# 58,863 isolates
rm(isolates_to_keep)
```

#### **Restrict to departments where PWH present**
#### **Select first isolate of an organism per patient**

```{r}
locations <- hivpos %>%
  left_join(susc3 %>% select(pat_mrn_id, department_name)) %>%
  select(department_name) %>%
  unique
susc4 <- susc3 %>%
  #filter(department_name %in% locations$department_name) %>%
  left_join(hivpos %>% select(pat_mrn_id, result_date, pwh)) %>% 
  mutate(pwh = ifelse(is.na(pwh), FALSE, pwh))
```

# **Descriptive statistics**

#### **Antibiotic class nonsusceptibility**

```{r}
susc5 <- susc4 %>%
  left_join(pts) %>%
  select(pat_mrn_id, age, race, female, ethnicity, encounter_number, result_date, culture_year, source, organism_name, genus, class, nonsusceptible, resistant_to_class, pwh, zip) %>%
  unique() %>%
  add_count(encounter_number, organism_name, class) %>%
  filter(n == 1 | (n > 1 & nonsusceptible),
         culture_year != 2022) %>%
  group_by(encounter_number, organism_name) %>%
  mutate(num_res = sum(nonsusceptible),
         mdr = ifelse(num_res > 2, TRUE, FALSE)) %>%
  ungroup() %>%
  unite(id, pat_mrn_id, organism_name, result_date, remove = FALSE) %>%
  select(-c(num_res, n))

d <- susc2 %>%
  filter(encounter_number %in% susc3$encounter_number)
d %>%
  tabyl(class, resistant_to_class) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages() %>%
  adorn_pct_formatting() %>%
  adorn_ns() %>%
  adorn_title()
```

#### **Multidrug-resistance**

```{r}
mdr <- susc5 %>%
  select(id, pat_mrn_id, age, race, ethnicity, organism_name, genus, mdr, culture_year, pwh, zip) %>%
  left_join(hivpos %>% select(pat_mrn_id)) %>%
  unique()
mdr %>%
  tabyl(pwh, mdr, culture_year) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages() %>%
  adorn_pct_formatting() %>%
  adorn_ns() %>%
  adorn_title()
mdr %>%
  filter(genus %in% c("escherichia", "klebsiella", "proteus", "citrobacter", "enterobacter")) %>%
  tabyl(organism_name, mdr) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages() %>%
  adorn_pct_formatting() %>%
  adorn_ns() %>%
  adorn_title()
# 40,633 isolates
# 35,065 patients
```

# **Join 2000-2018 data**

```{r}
zips <- demographics %>%
  clean_names() %>%
  mutate_all(list(tolower)) %>%
  select(current_mrn, zip) %>%
  rename(pat_mrn_id = current_mrn)
old_data <- data10 %>%
  filter(!class %in% c("fosfomycin", "glycopeptide", "lincosamide", "lipopeptide", "macrolide", "oxazolidinone", "polypeptide"),
         !is.na(class)) %>%
  mutate(age = floor(as.numeric(culture_date - dob) / 365.25),
         race = ifelse(is.na(race), "unknown", race),
         female = !male) %>%
  select(mrn, id, age, female, race, culture, source, antibiotic, class, resistant_to_class, mdr, hiv_pos, yr) %>%
  unique() %>%
  rename(culture_year = yr,
         pwh = hiv_pos,
         pat_mrn_id = mrn,
         organism_name = culture) %>%
  mutate(genus = word(organism_name, end = -2),
         genus = str_replace_all(genus, pattern = " cloacae| freundii| sakazakii| liquefaciens| vulgaris-penneri", ""),
         genus = ifelse(genus %in% c("enterobacter-klebsiella", "enterobacter (klebsiella)"), "enterobacter", genus),
         genus = ifelse(genus == "pantoea (enterobacter)", "pantoea", genus)) %>%
  left_join(zips)
all_data <-old_data %>%
  select(pat_mrn_id, id, age, female, race, source, organism_name, genus, class, resistant_to_class, mdr, culture_year, pwh, zip) %>%
  rbind(susc5 %>% select(pat_mrn_id, id, age, female, race, source, organism_name, genus, class, resistant_to_class, mdr, culture_year, pwh, zip)) %>%
  unique()
all_data_epic <-old_data %>%
  select(pat_mrn_id, id, age, female, race, source, organism_name, genus, class, resistant_to_class, mdr, culture_year, pwh, zip) %>%
  rbind(susc5 %>% select(pat_mrn_id, id, age, female, race, source, organism_name, genus, class, resistant_to_class, mdr, culture_year, pwh, zip)) %>%
  unique() %>%
  filter(culture_year > 2013)
all_data_epic %>%
  group_by(id, age, female, race, source, culture_year, pwh) %>%
  summarise() %>%
  tabyl(source, pwh) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting() %>%
  adorn_ns() %>%
  adorn_title()
all_data_epic %>%
  group_by(id, culture_year, mdr, pwh) %>%
  summarise() %>%
  tabyl(culture_year, mdr, pwh) %>% 
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting() %>%
  adorn_ns() %>%
  adorn_title()
# write.csv(all_data_epic, "culture_data_2014_2021.csv")
```

### **Prevalence ratios**

```{r}
df <- all_data
n_distinct(all_data$pat_mrn_id)
a <- df %>%
  mutate(age = ifelse(age > 75, 75, age),
         age_dich = ifelse((age > 50), TRUE, FALSE),
         spec_src = factor(source, levels = c("urine", "blood", "resp", "other")),
         race = factor(race, levels = c("white", "black", "other", "unknown")),
         male = !female) %>%
    ungroup
data <- a %>%
  group_by(id, pat_mrn_id, mdr, pwh, spec_src, age, age_dich, race, male, culture_year) %>%
  summarise() %>%
  ungroup

f3 <- function(fmla) {
  model <- glm(fmla, data = data %>% filter(!pwh, culture_year >= 2014), family = poisson(link = "log"))
  d <- (coeftest(model, vcov = sandwich))
  e <- cbind(d[,1], (confint(model)))
}
fmla <- mdr ~ spec_src
mod_rr <- f3(fmla)
as.data.frame(mod_rr) %>%
  rownames_to_column("feature") %>%
  mutate_if(is.numeric, round, 2) %>%
  rename(RR = V1) %>%
  clean_names() %>%
  rename(lwr = x2_5_percent,
         upr = x97_5_percent) %>%
  mutate(rr = round(exp(rr),2),
         lwr = round(exp(lwr),2),
         upr = round(exp(upr),2))


```

### **Overall prevalence of MDR by HIV status, 2014-2021**

```{r}
a <- all_data_epic %>%
  group_by(id, pwh, mdr) %>%
  summarise() %>%
  tabyl(pwh, mdr) %>%
  adorn_totals(c("row", "col")) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 1) %>%
  adorn_ns() %>%
  adorn_title()
kable_styling(kable(a, caption = "MDR by HIV status, 2014-2021"))
```

# **Charts**

```{r}
# mdr_all <- all_data %>%
#   group_by(id, pat_mrn_id, age, female, race, source, organism_name, genus, mdr, pwh) %>%
#   summarise() %>%
#   ungroup
# tb1 <- mdr_all %>%
#   filter(!is.na(female)) %>%
#   mutate(gend = ifelse(female, "Female", "Male"),
#          source2 = factor(source, levels = c("urine", "blood", "resp", "other"), labels = c("Urine", "Blood", "Resp", "Other")),
#          race2 = factor(race, levels = c("white", "black", "other"), labels = c("White", "Black", "Other"))) %>%
#   filter(!pwh)
# tb2 <- mdr_all %>%
#   filter(!is.na(female)) %>%
#   mutate(gend = ifelse(female, "Female", "Male"),
#          source2 = factor(source, levels = c("urine", "blood", "resp", "other"), labels = c("Urine", "Blood", "Resp", "Other")),
#          race2 = factor(race, levels = c("white", "black", "other"), labels = c("White", "Black", "Other"))) %>%
#   filter(pwh)
# # Sex
# PieChart(gend, hole = .5, values = "%", data = tb1, values_size = 2, labels_cex = 2, fill = "blues", main = "", pdf_file = "sex1")
# PieChart(gend, hole = .5, values = "%", data = tb2, values_size = 2, labels_cex = 2, fill = c("blues"), main = "", pdf_file = "sex2")
# # Race
# PieChart(race2, hole = .5, values = "%", data = tb1, values_size = 2, labels_cex = 2, fill = c("blues"), main = "", pdf_file = "race1")
# PieChart(race2, hole = .5, values = "%", data = tb2, values_size = 2, labels_cex = 2, fill = c("blues"), main = "", pdf_file = "race2")
# # Source
# PieChart(source2, hole = .5, values = "%", data = tb1, values_size = 2, labels_cex = 2, fill = c("blues"), main = "", pdf_file = "source1")
# PieChart(source2, hole = .5, values = "%", data = tb2, values_size = 2, labels_cex = 2, fill = c("blues"), main = "", pdf_file = "source2")
```

### **Trends in nonsusceptibility for E. coli and K. pneumoniae**

```{r}
tb <- all_data %>%
  group_by(id, culture_year, organism_name, class, resistant_to_class) %>%
  summarise() %>%
  group_by(organism_name, class, culture_year, resistant_to_class) %>%
  summarise(n = n()) %>%
  mutate(total = sum(n)) %>%
  filter(organism_name %in% c("escherichia coli", "klebsiella pneumoniae", "proteus mirabilis") & total > 50 & resistant_to_class & !class %in% c("amphenicol", "glycylcycline",   "nitrofuran", "tetracycline", "monobactam", "carbapenem")) %>%
  mutate(pct = round(n / total * 100)) %>%
  select(-resistant_to_class) %>%
  ungroup()
```

```{r fig.width=9, fig.height=5}
a <- tb %>%
  filter(organism_name == "escherichia coli")
chart <- ggplot(a, aes(x = culture_year, y = pct, group = class)) +
  geom_line(aes(color = class)) +
  ylim(0,55) +
  theme_classic() +
  xlab("Year") +
  ylab("% Nonsusceptible") +
  ggtitle("E. coli percent nonsusceptible by antibiotic class and year")
ggplotly(chart)
```

```{r fig.width=9, fig.height=5}
a <- tb %>%
  filter(organism_name == "klebsiella pneumoniae")
chart <- ggplot(a, aes(x = culture_year, y = pct, group = class)) +
  geom_line(aes(color = class)) +
  ylim(0,55) +
  theme_classic() +
  xlab("Year") +
  ylab("% Nonsusceptible") +
  ggtitle("K. pneumoniae percent nonsusceptible by antibiotic class and year")
ggplotly(chart)
```

### **Five-year moving average prevalence of MDR**

```{r moving average mdr by year, hiv status}
a <- all_data %>%
  group_by(id, culture_year, mdr, pwh) %>%
  summarise() %>%
  group_by(mdr, culture_year, pwh) %>%
  summarise(n = n()) %>%
  group_by(culture_year, pwh) %>%
  filter(mdr) %>%
  group_by(pwh) %>%
  arrange(culture_year, .by_group = TRUE) %>%
  mutate(num = rollmean(n, k = 5, fill = NA)) %>%
  ungroup() %>%
  select(-mdr)
b <- all_data %>%
  group_by(id, culture_year, pwh) %>%
  summarise() %>%
  group_by(culture_year, pwh) %>%
  summarise(n = n()) %>%
  group_by(pwh) %>%
  arrange(culture_year, .by_group = TRUE) %>%
  mutate(den = rollmean(n, k = 5, fill = NA)) %>%
  ungroup() 
tb_mdr <- a %>%
  mutate(den = b$den,
         mn = num / den * 100,
         mn = round(mn, 2),
         class = "Multidrug-resistant")
```

#### **Chart: Five-year moving average prevalence of MDR**

```{r}
ggplot(tb_mdr, aes(x = culture_year, y = mn, shape = pwh, linetype = pwh)) +
  geom_point(aes(group = pwh), size = 1.7) +
  geom_smooth(aes(group = pwh), method = "loess", se = FALSE, colour = "black", size = .5) +
  scale_shape_discrete(name = "",
                        breaks=c("TRUE", "FALSE"),
                        labels=c("People with HIV", "People without HIV")) +
  scale_linetype(name = "",
                        breaks=c("TRUE", "FALSE"),
                        labels=c("People with HIV", "People without HIV")) +
  theme(panel.border = element_blank(),  
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_blank(),
  axis.line = element_line(color = "grey")) +
  ylim(0, 40) +
  xlim(2000, 2020) +
  xlab("Calendar year") +
  ylab("Percent multidrug-resistant") +
  theme(text = element_text(size = 12), legend.position = c(.8, .9), legend.key = element_blank())
```

### **Prevalence of resistance to antibiotic classes, by HIV status**

```{r resistance in specific classes}
# class_factor <- c(aminoglycoside = "Aminoglycosides", cephalosporin_3rd_gen = "Cephalosporins 3rd generation", cephalosporin_2nd_gen = "Cephalosporins 2nd generation", nitrofuran = "Nitrofuran", penicillins = "Penicillins", penicillins_bli = "Penicillin + beta-lactamase inhibitor", polypeptide = "Polypeptides", sulfonamide = "Sulfonamides", quinolone = "Quinolones", mdr = "Multidrug-resistant")
overall_mdr <- all_data_epic %>%
  group_by(id, mdr, pwh) %>%
  summarise() %>%
  group_by(mdr, pwh) %>%
  summarise(subgroup = n()) %>%
  group_by(pwh) %>%
  mutate(group = sum(subgroup),
         pct_nonsusc = (subgroup / group) * 100, 
         pct_nonsusc = round(pct_nonsusc, 1),
         class = "mdr",
         resistant_to_class = TRUE) %>%
  filter(mdr)
classes <- all_data_epic %>%
  filter(class %in% c("aminoglycoside", "cephalosporin_2nd_gen", "cephalosporin_3rd_gen", "penicillins", "penicillins_bli", "sulfonamide", "quinolone")) %>%
  group_by(id, class, resistant_to_class, pwh) %>%
  summarise() %>%
  group_by(class, resistant_to_class, pwh) %>%
  summarise(subgroup = n()) %>%
  group_by(class, pwh) %>%
  mutate(group = sum(subgroup),
         pct_nonsusc = (subgroup / group) * 100, 
         pct_nonsusc = round(pct_nonsusc, 1)) %>%
  filter(resistant_to_class) %>%
  bind_rows(overall_mdr %>% select(-mdr)) %>%
  ungroup %>%
  mutate(class = factor(class, levels = c("aminoglycoside", "carbapenem", "cephalosporin_2nd_gen", "cephalosporin_3rd_gen", "penicillins", "penicillins_bli", "quinolone", "sulfonamide", "mdr")))
    # class = recode(class, !!!class_factor)) 
CIs <- binom.confint(x = classes$subgroup, n = classes$group, methods = "wilson")
classes$lower <- round(CIs$lower * 100, 1)
classes$upper <- round(CIs$upper * 100, 1)
nums_tested <- classes %>%
  select(class, pwh, group) %>%
  spread(pwh, group) %>%
  arrange(desc(class))
rm(overall_mdr)
```

#### **Chart: Percent resistant by antibiotic class and HIV status, 2014-2021**

```{r fig.width=7, fig.height=6}
names <- c("Aminoglycosides", "Cephalosporins 2nd generation", "Cephalosporins 3rd generation",  "Penicillins", "Penicillin + beta-lactamase inhibitor", "Quinolones", "Sulfonamides", "Multdrug-resistant")
ggplot(data = classes, aes(x = class, y = pct_nonsusc, ymin = lower, ymax = upper, shape = pwh)) + # Change color to shape
  geom_point(position = position_dodge(width = 0.4)) +
  scale_shape_discrete(name = "",
                        breaks=c("TRUE", "FALSE"),
                        labels=c("People with HIV", "People without HIV")) +
  geom_errorbar(width = .3, position = position_dodge(width = 0.4)) +
  theme(panel.border = element_blank(),  
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_blank(),
  axis.line = element_line(colour = "grey"),
  plot.caption = element_text(hjust = 0)) +
  scale_y_continuous("Percent nonsusceptible", breaks = seq(0, 70, 10), limits = c(0, 75)) + 
  xlab("") +
  scale_x_discrete(limits = rev) +
  theme(text = element_text(size = 12), legend.position = c(.80, .94), legend.key = element_blank()) +
  coord_flip()
```

#### **Chart: Predicted percent MDR by year and HIV status, using restricted cubic spline models**

```{r cubic spline mdr by year, hiv status}
a <- all_data %>%
  group_by(id, mdr, pwh, culture_year) %>%
  summarise() %>%
  ungroup()
pwh <- a %>% filter(pwh)
pwoh <- a %>% filter(!pwh)
mod <- lm(mdr ~ poly(culture_year, 6), data = pwh)
pwh$fit <- predict(mod)
mod <- lm(mdr ~ poly(culture_year, 6), data = pwoh)
pwoh$fit <- predict(mod)
all <- rbind(pwh, pwoh)
ggplot(data = all) +
  geom_smooth(aes(x = culture_year, y = fit * 100, colour = pwh)) +
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_blank(),
  axis.line = element_line(color = "grey")) +
  ylim(0, 40) +
  xlim(2002, 2020) +
  xlab("Calendar year") +
  ylab("Percent multidrug-resistant") +
  scale_color_brewer(name = "",
                        breaks = c("TRUE", "FALSE"),
                        labels = c("People with HIV", "People without HIV")) +
  theme(text = element_text(size = 12), legend.position = c(.8, .9), legend.key = element_blank())
rm(pwh,pwoh)
```

### **Five-year moving average resistance to antibiotic classes**

```{r rolling means}
f2 <- function(abx_class) {
  all_data %>%
    filter(class == abx_class) %>%
    group_by(id, culture_year, class, resistant_to_class, pwh) %>%
    summarise() %>%
    group_by(culture_year, class, resistant_to_class, pwh) %>%
    summarise(n = n()) %>%
    group_by(culture_year, class, pwh) %>%
    mutate(total = sum(n),
           total = ifelse(total <= 5, NA, total),
           pct = round(n / total * 100)) %>%
    filter(resistant_to_class) %>%
    group_by(pwh) %>%
    arrange(culture_year) %>%
    mutate(mn = rollmean(pct, k = 5, fill = NA)) %>%
    ungroup() %>%
    select(-resistant_to_class)
}
tb1 <- f2("aminoglycoside")
tb2 <- f2("cephalosporin_3rd_gen")
tb3 <- f2("penicillins")
tb4 <- f2("penicillins_bli")
tb5 <- f2("quinolone")
tb6 <- f2("sulfonamide")
tb <- tb1 %>%
  bind_rows(tb2, tb3, tb4, tb5, tb6) %>%
  mutate(class = factor(class, levels = c("aminoglycoside", "cephalosporin_3rd_gen", "penicillins", "penicillins_bli", "quinolone", "sulfonamide")))
        # class = recode(class, !!!class_factor))
datatable(tb, rownames = FALSE, colnames = gsub("[_]", " ", colnames(tb) %>% str_to_title()), caption = "Percent nonsusceptible with 5-year rolling mean by antibiotic class and HIV status")
rm(tb1,tb2,tb3,tb4,tb5,tb6)
```

#### **Chart: 5-year moving average percent nonsusceptible, by year, HIV status, and antibiotic class**

```{r fig.width=10, fig.height=6}
ggplot(tb, aes(x = culture_year, y = mn, shape = pwh)) +
  geom_point(aes(group = pwh), size = 1.7) +
  geom_smooth(aes(group = pwh, linetype = pwh), se = FALSE, method = "loess", color = "black", size = .5) +
  scale_shape_discrete(name = "",
                        breaks=c("TRUE", "FALSE"),
                        labels=c("People with HIV", "People without HIV")) +
  scale_linetype(name = "",
                        breaks=c("TRUE", "FALSE"),
                        labels=c("People with HIV", "People without HIV")) +
  theme(panel.border = element_blank(),  
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_blank(),
  axis.line = element_line(colour = "grey")) +
  ylim(0, 75) +
  xlab("Calendar year") +
  ylab("Percent non-susceptible") +
  theme(text = element_text(size = 14), legend.key = element_blank()) +
  facet_wrap(~ class, labeller = label_wrap_gen(width=20))
```

```{r}
# unadj_prs <- read_excel("C:/Users/henderh/Desktop/HAMR/HAMR_new_Rproj/unadj_prs.xlsx")
names <- c("Male (ref: female)", "Age >=50 (ref: 18-49)", "Black (ref: White)",  "Blood (ref: urine)", "Respiratory (ref:urine)")
df <- unadj_prs %>%
  mutate(pwh = as.character(pwh),
         feature = factor(feature, levels = c("male", "age", "black", "blood", "resp"), labels = names))

chart <- ggplot(data = df, aes(x = feature, y = rr, ymin = lwr, ymax = upr, colour = pwh)) +
  geom_hline(yintercept = 1, colour = "grey") +
  geom_point(position = position_dodge(width = 0.4)) +
  scale_colour_manual(name = "",
                        breaks=c("1", "0"),
                        labels=c("People with HIV", "People without HIV"),
                        values = c("darkred", "darkblue")) +
  geom_errorbar(width = .3, position = position_dodge(width = 0.4)) +
  theme(panel.border = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_blank(),
  axis.line = element_line(colour = "grey"),
  plot.caption = element_text(hjust = 0)) +
  scale_y_continuous("Unadjusted prevalence ratio", trans = "log10") +
  xlab("") +
  scale_x_discrete(limits = rev) +
  theme(text = element_text(size = 12), legend.position = c(.80, .94), legend.key = element_blank()) +
  coord_flip()
# ggsave(filename = "C:/Users/henderh/Desktop/HAMR/HAMR_new_Rproj/unadj_prs.tiff", plot = chart, device="tiff", dpi=600, width = 7, height = 4)
```








